#!/bin/bash

# ==============================================================================
# Project: PDFS - PDF Screenshooter
# Description: CLI tool to clip PDF pages to clipboard or save to file.
# License: GPL
# Version: 1.1.3 (Fix: Strict Numeric Matching)
# ==============================================================================

CONFIG_DIR="$HOME/.config/pdfs"
SESSION_FILE="$CONFIG_DIR/sessions.txt"
SETTINGS_FILE="$CONFIG_DIR/settings.conf"
SAVE_DIR="$HOME/Photos/pdfs"
VERSION="1.1.3"

RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

# --- INIT ---
if [ ! -d "$CONFIG_DIR" ]; then mkdir -p "$CONFIG_DIR"; touch "$SESSION_FILE"; fi
if [ ! -d "$SAVE_DIR" ]; then mkdir -p "$SAVE_DIR"; fi
if [ ! -f "$SETTINGS_FILE" ]; then echo "mode=copy" > "$SETTINGS_FILE"; fi

# --- HELPERS ---

check_deps() {
    local missing=0
    if ! command -v pdftoppm &> /dev/null; then echo -e "${RED}Missing: poppler-utils${NC}"; missing=1; fi
    if ! command -v wl-copy &> /dev/null; then echo -e "${RED}Missing: wl-clipboard${NC}"; missing=1; fi
    if [ $missing -eq 1 ]; then exit 1; fi
}

print_help() {
    echo -e "${BLUE}PDFS v${VERSION}${NC}"
    echo "Usage:"
    echo "  pdfs               : Session menu."
    echo "  pdfs [path]        : Temp session."
    echo "  pdfs -s [path]     : Save session."
    echo "  pdfs -d            : Delete session."
    echo "  pdfs -default      : Configure default action."
    echo "  pdfs -h            : Help."
}

configure_default() {
    echo -e "${BLUE}=== DEFAULT ACTION CONFIG ===${NC}"
    echo "Current default: $(grep "mode=" "$SETTINGS_FILE" | cut -d'=' -f2)"
    echo "1) Copy to Clipboard"
    echo "2) Save to Disk (~/Photos/pdfs)"
    read -p "Select > " choice

    case "$choice" in
        1) echo "mode=copy" > "$SETTINGS_FILE"; echo -e "${GREEN}Default set to: COPY${NC}" ;;
        2) echo "mode=save" > "$SETTINGS_FILE"; echo -e "${GREEN}Default set to: SAVE${NC}" ;;
        *) echo -e "${RED}Invalid choice.${NC}" ;;
    esac
}

process_page() {
    local file_path="$1"
    local page_num="$2"
    local flag="$3"
    local action=""
    
    if [[ "$flag" == "-s" ]]; then action="save";
    elif [[ "$flag" == "-c" ]]; then action="copy";
    else action=$(grep "mode=" "$SETTINGS_FILE" | cut -d'=' -f2); fi

    echo -e "${BLUE}[INFO]${NC} Processing page $page_num ($action)..."

    if [[ "$action" == "copy" ]]; then
        pdftoppm -png -f "$page_num" -l "$page_num" -r 300 "$file_path" | wl-copy --type image/png
        if [ $? -eq 0 ]; then echo -e "${GREEN}[OK]${NC} Copied to clipboard."; else echo -e "${RED}[ERR]${NC} Copy failed."; fi
    elif [[ "$action" == "save" ]]; then
        local base_name=$(basename "$file_path" .pdf)
        local out_file="$SAVE_DIR/${base_name}_p${page_num}.png"
        pdftoppm -png -f "$page_num" -l "$page_num" -r 300 "$file_path" > "$out_file"
        if [ $? -eq 0 ]; then echo -e "${GREEN}[OK]${NC} Saved: $out_file"; else echo -e "${RED}[ERR]${NC} Save failed."; fi
    fi
}

work_loop() {
    local target_dir="$1"
    if [ ! -d "$target_dir" ]; then echo -e "${RED}Dir not found: $target_dir${NC}"; exit 1; fi
    target_dir=$(realpath "$target_dir")
    cd "$target_dir" || exit

    while true; do
        echo -e "\n${BLUE}=== Work Dir: $target_dir ===${NC}"
        files=()
        
        # --- SIRALAMA GÜNCELLEMESİ ---
        # sort -V (Version sort) veya sort -n (Numeric sort) ile sırala
        while IFS= read -r f; do
            echo "  $f"
            files+=("$f")
        done < <(find . -maxdepth 1 -name "[0-9]*.pdf" -printf "%f\n" | sort -V)

        if [ ${#files[@]} -eq 0 ]; then echo -e "${RED}No numbered PDFs found.${NC}"; exit 1; fi

        echo -e "\n${GREEN}PDF No (Exit: 'q'):${NC}"
        read -p "> " pdf_input
        [[ "$pdf_input" == "q" ]] && exit 0

        selected_file=""
        for f in "${files[@]}"; do
            # --- KRİTİK GÜNCELLEME: MATEMATİKSEL EŞLEŞTİRME ---
            # 1. Dosya isminin başındaki sayıyı çek (Örn: "10ders..." -> "10")
            file_number=$(echo "$f" | grep -oE "^[0-9]+")
            
            # 2. Sayısal olarak kıyasla (Input: 1, File: 10 -> Eşit değil!)
            # 2>/dev/null, sayı olmayan girişlerin hata vermesini engeller
            if [ "$file_number" -eq "$pdf_input" ] 2>/dev/null; then
                selected_file="$f"
                break
            fi
        done

        if [ -z "$selected_file" ]; then echo -e "${RED}File not found or number mismatch.${NC}"; continue; fi

        echo -e "${BLUE}File: $selected_file${NC}"
        while true; do
            echo -e "Enter Page [Example: 45, 45 -s, 45 -c] ('q' back):"
            read -p "> " input_raw
            read -r -a input_arr <<< "$input_raw"
            page_num="${input_arr[0]}"
            flag="${input_arr[1]}"

            [[ "$page_num" == "q" ]] && break
            if [[ "$page_num" =~ ^[0-9]+$ ]]; then process_page "$selected_file" "$page_num" "$flag"; else echo -e "${RED}Invalid number.${NC}"; fi
        done
    done
}

save_session() {
    local raw_path="$*"
    if [ ! -d "$raw_path" ]; then
        echo -e "${RED}[ERROR] Directory does not exist: $raw_path${NC}"
        echo -e "${YELLOW}Hint: If path contains '&', wrap it in quotes!${NC}"
        exit 1
    fi
    local dir_path=$(realpath "$raw_path")

    if grep -q "|$dir_path$" "$SESSION_FILE"; then work_loop "$dir_path"; return; fi
    
    next_id=0
    for ((i=1; i<=200; i++)); do if ! grep -q "^$i|" "$SESSION_FILE"; then next_id=$i; break; fi; done
    if [ $next_id -eq 0 ]; then echo -e "${RED}Limit reached.${NC}"; exit 1; fi

    echo "$next_id|$dir_path" >> "$SESSION_FILE"
    echo -e "${GREEN}Saved: [$next_id] -> $dir_path${NC}"
    work_loop "$dir_path"
}

list_sessions() {
    if [ ! -s "$SESSION_FILE" ]; then echo -e "${YELLOW}No sessions.${NC}"; return 1; fi
    echo -e "${BLUE}=== SAVED SESSIONS ===${NC}"
    while IFS='|' read -r id path; do printf "${GREEN}[%3d]${NC} -> %s\n" "$id" "$path"; done < "$SESSION_FILE" | sort -n -k2
}

delete_session() {
    list_sessions; if [ $? -ne 0 ]; then exit 0; fi
    echo -e "\n${RED}Delete ID:${NC}"; read -p "> " del_id
    if grep -q "^$del_id|" "$SESSION_FILE"; then sed -i "/^$del_id|/d" "$SESSION_FILE"; echo -e "${GREEN}Deleted.${NC}"; else echo -e "${RED}Not found.${NC}"; fi
}

load_menu() {
    list_sessions; if [ $? -ne 0 ]; then print_help; exit 0; fi
    echo -e "\n${GREEN}Select ID:${NC}"; read -p "> " sel
    path=$(grep "^$sel|" "$SESSION_FILE" | cut -d'|' -f2)
    if [ -z "$path" ]; then echo -e "${RED}Invalid.${NC}"; exit 1; else work_loop "$path"; fi
}

# --- MAIN ---
check_deps
case "$1" in
    "-d") delete_session ;;
    "-s") 
        shift
        if [ -z "$1" ]; then echo -e "${RED}Path missing.${NC}"; exit 1; fi
        save_session "$@"
        ;;
    "-default") configure_default ;;
    "-h"|"--help") print_help ;;
    "") load_menu ;;
    *) 
        if [ -d "$1" ] || [ -d "$*" ]; then 
            if [ -d "$1" ]; then work_loop "$1"; else work_loop "$*"; fi
        else 
            print_help 
        fi 
        ;;
esac
