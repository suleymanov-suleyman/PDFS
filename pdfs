#!/bin/bash

# ==============================================================================
# Project: PDFS - PDF Screenshooter
# Description: CLI tool to clip PDF pages to clipboard or save to file.
# License: GPL
# Version: 2.0
# ==============================================================================

CONFIG_DIR="$HOME/.config/pdfs"
SESSION_FILE="$CONFIG_DIR/sessions.txt"
SETTINGS_FILE="$CONFIG_DIR/settings.conf"
SAVE_DIR="$HOME/Photos/pdfs"

RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

mkdir -p "$CONFIG_DIR" "$SAVE_DIR"
touch "$SESSION_FILE"
[ ! -f "$SETTINGS_FILE" ] && echo "mode=copy" > "$SETTINGS_FILE"

check_deps() {
    local missing=0
    command -v pdftoppm &>/dev/null || { echo -e "${RED}Missing: poppler-utils${NC}"; missing=1; }
    command -v wl-copy &>/dev/null || { echo -e "${RED}Missing: wl-clipboard${NC}"; missing=1; }
    command -v python3 &>/dev/null || { echo -e "${RED}Missing: python3${NC}"; missing=1; }
    [ $missing -eq 1 ] && exit 1
}

get_sorted_files() {
python3 - <<'EOF'
import os, re
files = [f for f in os.listdir('.') if f.lower().endswith('.pdf')]
files.sort(key=lambda x: [int(c) if c.isdigit() else c.lower()
                           for c in re.split(r'(\d+)', x)])
for f in files:
    print(f)
EOF
}

process_page() {
    local file="$1"
    local page="$2"
    local flag="$3"
    local action

    if [[ "$flag" == "-s" ]]; then
        action="save"
    elif [[ "$flag" == "-c" ]]; then
        action="copy"
    else
        action=$(cut -d= -f2 "$SETTINGS_FILE")
    fi

    echo -e "${BLUE}[INFO]${NC} Page $page ($action)"

    if [[ "$action" == "copy" ]]; then
        pdftoppm -png -f "$page" -l "$page" -r 300 "$file" | wl-copy --type image/png
    else
        base=$(basename "$file" .pdf)
        out="$SAVE_DIR/${base}_p${page}.png"
        pdftoppm -png -f "$page" -l "$page" -r 300 "$file" > "$out"
        echo -e "${GREEN}[OK]${NC} Saved: $out"
    fi
}

work_loop() {
    local dir="$1"

    [ ! -d "$dir" ] && { echo -e "${RED}Dir not found${NC}"; exit 1; }
    cd "$(realpath "$dir")" || exit

    while true; do
        echo -e "\n${BLUE}=== Work Dir: $(pwd) ===${NC}"

        mapfile -t pdfs < <(get_sorted_files)
        [ ${#pdfs[@]} -eq 0 ] && { echo -e "${RED}No PDFs found${NC}"; exit 1; }

        echo -e "${CYAN}Available PDFs:${NC}"
        for i in "${!pdfs[@]}"; do
            printf "${GREEN}[%d]${NC} %s\n" "$((i+1))" "${pdfs[$i]}"
        done

        echo -e "\n${YELLOW}Select PDF number (q=exit):${NC}"
        read -p "> " sel
        [[ "$sel" == "q" ]] && exit 0

        if [[ "$sel" =~ ^[0-9]+$ ]] && [ "$sel" -ge 1 ] && [ "$sel" -le "${#pdfs[@]}" ]; then
            selected="${pdfs[$((sel-1))]}"
        else
            echo -e "${RED}Invalid selection${NC}"
            continue
        fi

        echo -e "${BLUE}Selected:${NC} $selected"

        while true; do
            echo -e "${YELLOW}Enter page number (q=back):${NC}"
            read -p "> " raw
            read -r page flag <<< "$raw"

            [[ "$page" == "q" ]] && break
            [[ "$page" =~ ^[0-9]+$ ]] || { echo -e "${RED}Invalid page${NC}"; continue; }

            process_page "$selected" "$page" "$flag"
        done
    done
}

check_deps

case "$1" in
    -s) shift; work_loop "$*" ;;
    -default)
        echo "1) Copy  2) Save"
        read -p "> " c
        [ "$c" == "1" ] && echo "mode=copy" > "$SETTINGS_FILE"
        [ "$c" == "2" ] && echo "mode=save" > "$SETTINGS_FILE"
        ;;
    -h)
        echo "Usage: pdfs -s <path>"
        ;;
    *)
        echo "Usage: pdfs -s <path>"
        ;;
esac
